---
title: "Ecology is the main driver of primate brain size evolution"
subtitle: "Main analyses"
author: "Sereina Graber"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    number_sections: true
    toc: true
    toc_float: true
    theme: lumen
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

# packages
library(rprojroot)
library(readxl)

library(tidyverse)
library(magrittr)
library(patchwork)
library(data.table)
library(knitr)
library(kableExtra)

library(caper)
library(nlme)
library(ape)
library(phytools)
library(phylopath)
library(MCMCglmm)

# load functions
source('00_socio_ecology_functions.R')
```


```{r data}
# load data preparation
source('01_socio_ecology_data_prep.R')
```




<br><br>




# Supplementary Material & Methods

## Phylogenetic tree
```{r, fig.height = 12, fig.width = 17, fig.align = "center", fig.cap = "Phylogenetic tree of the 92 primate species showing the availability of information on the variables in the four domains including social/ecological opportunity and consequence variables."}

# function from 00_socio_ecology_function.R
tree_circular_var(data = data1, tree = Petree, 
                  size.text = 1.4, size.legend = 1.3,
                  x.pos.legend = -190, y.pos.legend = -120)

```

<br><br>

## Numerical coding of variables
```{r}
num_coding <- read_xlsx(file.path(find_rstudio_root_file(), "Data/numerical_coding_variables.xlsx"),
                                  sheet = 1, 
                                  col_names = TRUE)

num_coding %>% 
  kable_custom(caption = "Measurements and numerical coding of variables.") %>% 
  pack_rows(., 'Social opportunities', 1, 11) %>% 
  pack_rows(., 'Ecological opportunities', 12, 22) %>% 
  pack_rows(., 'Socio-cognitive consquences', 23, 26) %>% 
  pack_rows(., 'Socio-cognitive consquences', 27, 31) 
```






<br><br>



# Supplementary Tables and Analyses of Robustness: Phylogenetic Least-Squares Regressions

<br>

We tested the robustness of our conclusions in several different ways.

*First*, we systematically excluded each of the variables from the pPCAs, and reran the subsequent PGLS regressions with the corresponding PCs to exclude the possibility that the relationships might actually be driven by a single variable. For the social opportunities, excluding single variables from the pPCA resulted in the majority of the cases in non-significant effects of the resulting two PCs on relative brain size (Table \@ref(tab:socopploo) ). For the ecological opportunity variables, the effects of the PCs on relative brain size remained basically similar (and significant for PC1), independent of which variable was excluded from the pPCA (Table \@ref(tab:ecoopploo)). These findings imply that the statistical trend of PC1 of the social opportunities in the original analysis is not robust and thus reinforces ecology as the main driver of primate brain size evolution. The analogous analyses regarding consequence variables did not change our main findings (Tables \@ref(tab:socconsloo), \@ref(tab:ecoconsloo)). Only the exclusion of hunting from the pPCA encompassing the ecological consequences yielded a non-significant result of PC1 with relative brain size, but that was because the factor loadings of the pPCA redistributed and loaded also highly on the second PC, which therefore showed a highly significant association with relative brain size (not shown).

*Second*, we reclassified variables for which the assignment to opportunities could be questioned (fission- fusion and extractive foraging). Living in a fission-fusion society might not necessarily require a large brain, and is therefore classified as an opportunity variable. However, it has also been argued to require enhanced cognition in terms of long-term memory and recognition, in which case it should be classified as a consequence. Extractive foraging, on the one hand can be classified as an opportunity, since it simply represents a foraging technique used for specific types of foods (e.g. roots, tubers, specific insects), in special cases with morphological adaptations (e.g. Daubentonia madagascariensis), which does not necessarily require enhanced cognition. On the other hand, extracting foods from embedding matrices, closely linked to tool use, can be argued to be intrinsically cognitively demanding, in which case it must be classified as a consequence variable. This reclassification from opportunities to consequences made our results even stronger (see subsection 3.8).

*Finally*, we excluded striking outliers (*Cebus capucinus*, *Cebus apella*, *Pan troglodytes*) (\@ref(tab:socconsexcl), \@ref(tab:ecoconsexcl), \@ref(tab:socecoconsexcl)), conducted non-parametric jackknife without replacement (shown only for the combined model of opportunities, Table \@ref(tab:jackknife)) and used common limited samples (where data were available on both social and ecological opportunity variables as well as the consequence variables, not shown), but also none of this changed our results.


<br><br>


## Social opportunities

### Phylogenetic PCA
```{r, results='hide'}

# choose variables to perform pPCA on:
variables <- c('Home range overlap', 'Vocal terr. advertisement',
                'Group size', 'Gregariousness', 'Fission-fusion',
                'Body size dimorphism', 'Visual trait dimorphism',
                'Cooperative breeding', 'Dispersal', 'Social system',
                'Mating system')

# Phylogenetic PCA (function in 00_socio_ecology_functions.R)
pca.soc.opp <- phylo_pca(vars = variables, 
                         data = data1, 
                         tree = Petree, 
                         type = 'Social Opportunity',
                         invert.loading = 'PC1')
```

```{r}
# output table PCA
kable_phylo_pca_loadings(pca.soc.opp$PC.loadings)
```


<br><br>

### PGLS with PC scores
```{r}
# add individual PC scores to data set
data1_soc_opp <- merge(data1, pca.soc.opp$PC.scores, by = "Genus_species", all.x = T)
# add residuals to data set for plotting
data1_soc_opp$ResBrainBody <- resid(m1 <- lm(log(Brain.Size) ~ log(Body.Mass), data = data1_soc_opp, na.action = na.exclude))

# comparative data for PGLS
comp_data <- comparative.data(phy = Petree, data = data1_soc_opp, names.col = Genus_species, 
                              vcv = TRUE, na.omit = FALSE, warn.dropped = TRUE ,vcv.dim = 3)

# PGLS analyses
model1 <- pgls(log(Brain.Size) ~  log(Body.Mass) + PC1.Social.Opportunity, data = comp_data, lambda = 'ML')
kable_pgls(model1)
model1 <- pgls(log(Brain.Size) ~  log(Body.Mass) + PC2.Social.Opportunity, data = comp_data, lambda = 'ML')
kable_pgls(model1)
model1 <- pgls(log(Brain.Size) ~  log(Body.Mass) + PC1.Social.Opportunity + PC2.Social.Opportunity, data = comp_data, lambda = 'ML')
kable_pgls(model1)

```

<br><br>

### PGLS with pPCAs where systematically each of the variables is left out 

```{r , results = 'hide'}
tab.leave.one.out <- leave_one_out(vars = variables, 
                                     data = data1, 
                                     tree = Petree,
                                     type = 'Social Opportunity')
```

```{r socopploo}
tab.leave.one.out %>% 
  round(., digits = 4) %>% 
  kable_custom(., caption = 'Estimates and p-values of the effects of PC1 and PC2 of the social opportunities on relative brain size  (mulitple PGLS regression). In the first row the result of the original analysis is given, in the subsequent rows, the results are based on PCs from pPCAs where systematically each of the variable is left out.')
```

<br><br>

## Ecological opportunities
### Phylogenetic PCA
```{r, results='hide'}

# choose variables to perform pPCA on:
variables <- c('Predation risk', 'Mobility D-index', 'Env. seasonality',
               '% insects and meat in diet', '% fruits and seeds in diet', '% leaves in diet', 
               'Extractive foraging', 'Diet quality', 'Substrate', 'Activity', 'Habitat')

# Phylogenetic PCA (function in 00_socio_ecology_functions.R)
pca.eco.opp <- phylo_pca(vars = variables, 
                         data = data1, 
                         tree = Petree, 
                         type = 'Ecological Opportunity',
                         invert.loading = 'PC1')
```

```{r}
# output table PCA
kable_phylo_pca_loadings(pca.eco.opp$PC.loadings)
```

<br><br>

### PGLS with PC scores
```{r}
# add individual PC scores to data set
data1_eco_opp <- merge(data1, pca.eco.opp$PC.scores, by = "Genus_species", all.x = T)
# add residuals to data set for plotting
data1_eco_opp$ResBrainBody <- resid(m1 <- lm(log(Brain.Size) ~ log(Body.Mass), data = data1_eco_opp, na.action = na.exclude))

# comparative data for PGLS
comp_data <- comparative.data(phy = Petree, data = data1_eco_opp, names.col = Genus_species, vcv = TRUE, na.omit = FALSE, warn.dropped = TRUE ,vcv.dim = 3)

# PGLS analyses
model1 <- pgls(log(Brain.Size) ~  log(Body.Mass) + PC1.Ecological.Opportunity, data = comp_data, lambda = 'ML')
kable_pgls(model1)
model1 <- pgls(log(Brain.Size) ~  log(Body.Mass) + PC2.Ecological.Opportunity, data = comp_data, lambda = 'ML')
kable_pgls(model1)
model1 <- pgls(log(Brain.Size) ~  log(Body.Mass) + PC1.Ecological.Opportunity + PC2.Ecological.Opportunity, data = comp_data, lambda='ML')
kable_pgls(model1)

```

<br><br>

### PGLS with pPCAs where systematically each of the variables is left out 

```{r, results = 'hide'}
tab.leave.one.out <- leave_one_out(vars = variables, data = data1, tree = Petree, type = 'Ecological Opportunity')
```

```{r ecoopploo}
tab.leave.one.out %>% 
  round(., digits = 4) %>% 
  kable_custom(., caption = 'Estimates and p-values of the effects of PC1 and PC2 of the ecological opportunities on relative brain size  (mulitple PGLS regression). In the first row the result of the original analysis is given, in the subsequent rows, the results are based on PCs from pPCAs where systematically each of the variable is left out.')
```




<br><br>




## Social and Ecological Opportunities - common sample

```{r common sample}
# Merge social and ecological PCs to data
data1_soc_eco_opp <- 
  data1 %>% 
    left_join(pca.soc.opp$PC.scores, by = 'Genus_species') %>% 
    left_join(pca.eco.opp$PC.scores, by = 'Genus_species') %>% 
    dplyr::select('Genus_species', 'Body.Mass', 'Brain.Size', dplyr::matches('PC1|PC2')) %>% 
    filter(complete.cases(.))

# add residuals for plotting
data1_soc_eco_opp$ResBrainBody <- resid(m1 <- lm(log(Brain.Size) ~ log(Body.Mass), 
                                                 data = data1_soc_eco_opp, 
                                                 na.action = na.exclude)
                                        )
# comparative data
comp_data <- comparative.data(phy = Petree, data = data1_soc_eco_opp, 
                              names.col = Genus_species, vcv = TRUE, 
                              na.omit = FALSE, warn.dropped = TRUE , vcv.dim = 3)


# match tree and data
matches <- match(Petree$tip.label, data1_soc_eco_opp$Genus_species, nomatch = 0)
not <- subset(Petree$tip.label, matches == 0)
tree_pruned_soc_eco_opp <- drop.tip(Petree, not)
```


```{r plot regression opportunities}

# plot for paper (Figure 2, A-D)

data1_soc_eco_opp_long <- data1_soc_eco_opp %>% 
                                pivot_longer(
                                 cols = starts_with("PC"),
                                 names_to = "PC_type",
                                 names_prefix = "",
                                 values_to = "PC_values",
                                 values_drop_na = TRUE
                               ) %>% 
  mutate(PC_type = factor(x = PC_type, 
                          levels = c('PC1.Social.Opportunity', 'PC2.Social.Opportunity',
                                     'PC1.Ecological.Opportunity', 'PC2.Ecological.Opportunity'),
                          labels = c('PC1 Social Opportunities', 'PC2 Social Opportunities',
                                    'PC1 Ecological Opportunities', 'PC2 Ecological Opportunities')
                          )
         ) %>% 
  left_join(data1[,c('Genus_species', 'family')], by = 'Genus_species')


labels <- data.frame(PC_type = c("PC1 Social Opportunities", "PC2 Social Opportunities",
                               "PC1 Ecological Opportunities", "PC2 Ecological Opportunities"),
                       plot_labels = c("A", "B", "C", "D"),
                       pvalue_labels = c("p = 0.442", "p = 0.699", "p = 0.024", "p = 0.089")
                       )

# slopes <- data.frame(PC_type = c("PC1 Social Opportunities", "PC2 Social Opportunities",
#                                "PC1 Ecological Opportunities", "PC2 Ecological Opportunities"),
#                      intercept = jackknife_res$Jackknife.Summary['(Intercept)', 'Original estimate'],
#                      slopes = jackknife_res$Jackknife.Summary[ 3:6, 'Original estimate']
#                      )

p.A.D <- data1_soc_eco_opp_long %>% 
  ggplot(., aes(x = PC_values, y = ResBrainBody)) +
    geom_point(aes(color = family, shape = family), size = 2.5) + 
    scale_shape_manual(values=c(15, 16, 17, 18, 11, 13, 8, 10, 25)) +
    scale_color_brewer(palette="Paired") +
    geom_smooth(method='lm', se = FALSE, color = 'darkgray') + 
    #geom_abline(aes(intercept = intercept,  slope = slopes), data = slopes)  +
    labs(x = 'PC values', y = 'Residuals brain size') +
    facet_wrap(~ PC_type) +
    theme(panel.border = element_rect(fill = NA, colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          strip.background = element_blank(),
          axis.line = element_line(colour = "grey"),
          legend.key = element_rect(fill = "white")
          ) +
    geom_text(x = -29, y = 0.55, aes(label = plot_labels), data = labels) +
    geom_text(x =  25, y = -0.77, aes(label = pvalue_labels), data = labels)
    

```




```{r jackknife}
# jaccknife resampling
set.seed(123)
jackknife_res <- jackknife_pgls(n_iter = 1000, 
                       subsample_size = 0.8, 
                       data = data1_soc_eco_opp, 
                       response = "log(Brain.Size)", 
                       predictors = c("PC1.Social.Opportunity", "PC2.Social.Opportunity",
                                      "PC1.Ecological.Opportunity", "PC2.Ecological.Opportunity"), 
                       opp = TRUE)


# make nice output table
jackknife_res$Jackknife.Summary %>% 
  # round(., digits = 4) %>% 
  kable_custom(., caption = paste0('Jackknife resampling (over tips) of PGLS regression model including all four opportunity PCs: $N_{iter}$ = ', nrow(jackknife_res$Jackknife.Estimates), ', subsample size = ', jackknife_res$Jackknife.Subsample, ' (80% of N = 43). Given are the original estimates and corresponding p-values from the original PGLS regression as well as the mean estimates and 95% confidence intervals (CI) of the jackknifed sample.'))
```

<br>

```{r plot jackknife distribution}

dat <- jackknife_res$Jackknife.Estimates
dat <- as.data.frame(dat[!dat[,1] == 999, ])


# Plot for paper (Figure 2 E, F)

### ============================ PLOT VERSION 1 ================================

# theme_density <- theme(
#         axis.title = element_text(size = 13, color = "black"),
#         axis.text.x  = element_text(vjust = 0.5, size = 12),
#         axis.text.y = element_text(vjust = 0.5, size = 13),
#         panel.border = element_rect(fill = NA, size = 2),
#         #plot.title = element_text(size = 20),
#         panel.background = element_blank(),
#         strip.background = element_blank(),
#         legend.position = c(0.78, 0.7),
#         legend.title = element_blank(),
#         legend.text = element_text(size = 11))

# PC1
# p.pc1 <- ggplot(data = dat) +
#   geom_density(aes(x = PC1.Ecological.Opportunity, fill = 'ecological opp.'),  alpha = 0.5) +
#   geom_density(aes(x = PC1.Social.Opportunity, fill = 'social opp.'), alpha = 0.5) +
#   scale_fill_manual( values = c("olivedrab4","steelblue3")) +
#   theme_2 +
#   labs(x = 'Estimates PC1')
# 
# # PC2 
# p.pc2 <- ggplot(data = dat) +
#   geom_density(aes(x = PC2.Ecological.Opportunity, fill = "ecological opp."), alpha = 0.5) +
#   geom_density(aes(x = PC2.Social.Opportunity, fill = "social opp."), alpha = 0.5) +
#   scale_fill_manual( values = c("olivedrab4","steelblue3")) +
#   theme_2 +
#   labs(x = 'Estimates PC2')

# p.pc1 + p.pc2 + 
#   plot_annotation(title = '1000 Jackknife replicates of combined plgs model', tag_levels = 'A') &
#   theme(plot.title = element_text(size = 16), 
#         plot.tag = element_text(size = 14))



### ============================ PLOT VERSION 2 ================================

theme_density_2 <- theme(panel.border = element_rect(fill = NA, colour = "black"),
                panel.grid.major = element_blank(),
                panel.grid.minor = element_blank(),
                panel.background = element_blank(),
                strip.background = element_blank(),
                #legend.position = c(0.85, 0.85),
                axis.line = element_line(colour = "grey"),
                legend.key = element_rect(fill = "white"),
                legend.title=element_blank()
                )

dat_long <- dat %>% 
                pivot_longer(cols = starts_with("PC"),
                             names_to = "PC_type",
                             names_prefix = "PC",
                             values_to = "PC_values",
                             values_drop_na = TRUE) %>% 
                separate(PC_type, c("PC", "Opportunity_type")) %>% 
                pivot_wider(names_from = 'Opportunity_type', values_from = 'PC_values') 

labels_EF <- data.frame(PC = c("1", "2"),
                        plot_labels = c("E", "F"))

p.E.F <- dat_long %>% 
  ggplot(.) +
  geom_density(aes(x = Ecological, fill = "ecological opp."), alpha = 0.5) +
  geom_density(aes(x = Social, fill = "social opp."), alpha = 0.5) +
  scale_fill_manual( values = c("olivedrab4","steelblue3")) +
  theme_density_2 +
  labs(x = 'Estimates') + 
  facet_wrap(~ paste0('PC ', PC) )  +
  geom_text(x = -0.01, y = 220, aes(label = plot_labels), data = labels_EF)

```

```{r figure 2, fig.height = 8, fig.align = 'center', fig.cap = "Unidirectional Analysis: PGLS on Opportunities. Bivariate relationships between relative brain size (residuals of log brain vs. log body) and the principal components of the social (A, B) and ecological (C, D) opportunities (N=43; presented are raw, non-phylogenetically corrected data; p-values are based on the PGLS regression model). Density distributions are the result of 1,000 jackknife resampling replicates of PGLS regression estimates (E, F; Table 2.7)"}

### ========================= PUT PLOTS INTO ONE PLOT  =========================

p.A.D + p.E.F +
  plot_layout(ncol = 1, heights = c(2,1))

```

<br>

```{r AIC model comparison I, results = 'hide'}

formulas <- c('log(Brain.Size) ~  log(Body.Mass) + PC1.Social.Opportunity + PC2.Social.Opportunity',
              'log(Brain.Size) ~  log(Body.Mass) + PC1.Ecological.Opportunity + PC2.Ecological.Opportunity',
              'log(Brain.Size) ~  log(Body.Mass) + PC1.Social.Opportunity + PC1.Ecological.Opportunity',
              'log(Brain.Size) ~  log(Body.Mass) + PC2.Social.Opportunity + PC2.Ecological.Opportunity',
              'log(Brain.Size) ~  log(Body.Mass) + PC1.Social.Opportunity + PC2.Ecological.Opportunity',
              'log(Brain.Size) ~  log(Body.Mass) + PC2.Social.Opportunity + PC1.Ecological.Opportunity',
              'log(Brain.Size) ~  log(Body.Mass) + PC1.Ecological.Opportunity + PC2.Ecological.Opportunity + PC1.Social.Opportunity + PC2.Social.Opportunity')

# run pgls and extract esimates/p-values for each formula from above
tab_estimates <- do.call('rbind', 
                         lapply(formulas, function(x) extract_estimates(x, 
                                                                     data = data1_soc_eco_opp, 
                                                                     tree_pruned = tree_pruned_soc_eco_opp))
                         )
```

```{r AIC model comparison II}
# restructure table
tab_estimates %<>% 
  mutate(value = paste0(round(estimate, 3), ' (', round(`p-value`, 3), ')')) %>% 
  dplyr::select(variable, AIC, value) %>% 
  pivot_wider(names_from = variable, values_from = c(value)) %>% 
  mutate(model = paste0('model ', row_number())) %>% 
  dplyr::select(model, everything()) %>% 
  # no AIC for mcmcglmm, take old value from pgls anlysis from thesis where pgls() gave no error back then !!
  mutate(AIC = replace(AIC, model == 'model 6', -30.66)) %>% 
  replace(is.na(.), '-')

# rename colnames, to make them shorter
colnames(tab_estimates) <- gsub('Opportunity', 'Opp.', colnames(tab_estimates))
  
# nice output table
tab_estimates %>% 
  kable_custom(., caption = paste0('Model selection based on Akaike Information Criterion (AIC). PGLS models with log brain size as the response and the social and ecological opportunity PCs as predictor variables. Models are based on the common sample of social and ecological opportunities (', nrow(data1_soc_eco_opp)  ,') and include log body mass as a covariate. Given are the estimates and corresponding p-values in brackets.'))
```


<br><br>


## Relationship between social and ecological opportunities
```{r relationship social and ecological opps}

formulas_rel <- c('PC1.Social.Opportunity ~ PC1.Ecological.Opportunity',
              'PC2.Social.Opportunity ~ PC2.Ecological.Opportunity',
              'PC1.Social.Opportunity ~ PC2.Ecological.Opportunity',
              'PC2.Social.Opportunity ~ PC1.Ecological.Opportunity',
              'PC1.Ecological.Opportunity ~ PC1.Social.Opportunity',
              'PC2.Ecological.Opportunity ~ PC2.Social.Opportunity',
              'PC2.Ecological.Opportunity ~ PC1.Social.Opportunity', 
              'PC1.Ecological.Opportunity ~ PC2.Social.Opportunity')

# run pgls and extract esimates/p-values for each formula from above
tab_estimates_rel <- do.call('rbind', 
                         lapply(formulas_rel, function(x) extract_estimates(x, 
                                                                     data = data1_soc_eco_opp, 
                                                                     tree_pruned = tree_pruned_soc_eco_opp,
                                                                     minus_coef = c(1)))
                         )

tab_estimates_rel %<>% 
  add_column(`Response variable` = sapply(str_split(formulas_rel, ' ~ '), `[[`, 1), .before = 1) %>% 
  add_column(`Predictor variable` = sapply(str_split(formulas_rel, ' ~ '), `[[`, 2), .before = 2) %>% 
  dplyr::select(-variable, -AIC) %>% 
  mutate(estimate = round(estimate, 3), `p-value` = round(`p-value`, 3))

rownames(tab_estimates_rel) <- NULL

# nice output table
tab_estimates_rel %>% 
  kable_custom(., caption = paste0('Relationships between social and ecological opportunity PCs. PGLS models are based on the common sample of social and ecological opportunity variables ($N=43$). Given are the estimates and corresponding p-values.'))
```




<br><br>




## Social consequences
### Phylogenetic PCA
```{r, results='hide'}

# choose variables to perform pPCA on:
variables <- c('Social learning frequency', 'Coalition formation', 'Social hunting',
               'Food sharing among adults')

# Phylogenetic PCA (function in 00_socio_ecology_functions.R)
pca.soc.cons <- phylo_pca(vars = variables, 
                         data = data1, 
                         tree = Petree, 
                         type = 'Social Consequence')
```

```{r}
# output table PCA
kable_phylo_pca_loadings(pca.soc.cons$PC.loadings)
```

<br><br>

### PGLS with PC scores
```{r}
# add individual PC scores to data set
data1_PC <- merge(data1, pca.soc.cons$PC.scores, by="Genus_species", all.x=T)
# add residuals to data set for plotting
data1_PC$ResBrainBody <- resid(m1<-lm(log(Brain.Size) ~ log(Body.Mass), data = data1_PC, na.action=na.exclude))

# comparative data for PGLS
comp_data <- comparative.data(phy = Petree, data = data1_PC, names.col = Genus_species, vcv = TRUE, na.omit = FALSE, warn.dropped = TRUE ,vcv.dim=3)

# PGLS analyses
model1 <- pgls(PC1.Social.Consequence ~  log(Body.Mass) + log(Brain.Size), data = comp_data, lambda='ML')
kable_pgls(model1)
model1 <- pgls(PC2.Social.Consequence ~  log(Body.Mass) + log(Brain.Size), data = comp_data, lambda='ML')
kable_pgls(model1)

```

<br><br>

### PGLS with pPCAs where systematically each of the variables is left out 

```{r, results = 'hide'}
tab.leave.one.out <- leave_one_out(vars = variables, data = data1, tree = Petree, type = 'Social Consequences', PC = 1)
```

```{r socconsloo}
tab.leave.one.out %>% 
  round(., digits = 4) %>% 
  kable_custom(., caption = 'Estimates and p-values of the effects of brain size on PC1 of the social consequences (mulitple PGLS regression). In the first row the result of the original analysis is given, in the subsequent rows, the results are based on PCs from pPCAs where systematically each of the variable is left out.')
```

<br><br>

### PGLS excluding outliers - *Cebus capucinus*, *Cebus apella*, *Pan troglodytes*

```{r socconsexcl}

# exclude outliers
data1_PC_excl <- data1_PC %>%
                    filter(!Genus_species %in% c("Cebus_capucinus", "Cebus_apella", "Pan_troglodytes"))

# comparative data for PGLS
comp_data_excl <- comparative.data(phy = Petree, data = data1_PC_excl, names.col = Genus_species, vcv = TRUE, na.omit = FALSE, warn.dropped = TRUE ,vcv.dim=3)

# PGLS analyses
model1 <- pgls(PC1.Social.Consequence ~  log(Body.Mass) + log(Brain.Size), data = comp_data_excl, lambda='ML')
kable_pgls(model1)
# model1 <- pgls(PC2.Social.Consequence ~  log(Body.Mass) + log(Brain.Size), data = comp_data_excl, lambda='ML')
# kable_pgls(model1)
```



<br><br>




## Ecological consequences
### Phylogenetic PCA
```{r, results = 'hide'}

# choose variables to perform pPCA on:
variables <- c('Degree of buffering env. seasonality', 'Diet breadth', 'Hunting',
               'Tool use', 'Innovation frequency')

# Phylogenetic PCA (function in 00_socio_ecology_functions.R)
pca.eco.cons <- phylo_pca(vars = variables, 
                         data = data1, 
                         tree = Petree, 
                         type = 'Ecological Consequence')
```

```{r}
# output table PCA
kable_phylo_pca_loadings(pca.eco.cons$PC.loadings)
```

<br><br>

### PGLS with PC scores
```{r}
# add individual PC scores to data set
data1_PC <- merge(data1, pca.eco.cons$PC.scores, by="Genus_species", all.x=T)
# add residuals to data set for plotting
data1_PC$ResBrainBody <- resid(m1<-lm(log(Brain.Size) ~ log(Body.Mass), data = data1_PC, na.action=na.exclude))

# comparative data for PGLS
comp_data <- comparative.data(phy = Petree, data = data1_PC, names.col = Genus_species, vcv = TRUE, na.omit = FALSE, warn.dropped = TRUE ,vcv.dim=3)

# PGLS analyses
model1 <- pgls(PC1.Ecological.Consequence ~  log(Body.Mass) + log(Brain.Size), data = comp_data, lambda='ML')
kable_pgls(model1)
model1 <- pgls(PC2.Ecological.Consequence ~  log(Body.Mass) + log(Brain.Size), data = comp_data, lambda='ML')
kable_pgls(model1)

```

<br><br>

### PGLS with pPCAs where systematically each of the variables is left out 

```{r, results = 'hide'}
tab.leave.one.out <- leave_one_out(vars = variables, data = data1, tree = Petree, type = 'Ecological Consequences', PC = 1)
```

```{r ecoconsloo}
tab.leave.one.out %>% 
  round(., digits = 4) %>% 
  kable_custom(., caption = 'Estimates and p-values of the effects of brain size on PC1 of the ecological consequences (mulitple PGLS regression). In the first row the result of the original analysis is given, in the subsequent rows, the results are based on PCs from pPCAs where systematically each of the variable is left out.')
```

<br><br>

### PGLS excluding outliers - *Cebus capucinus*, *Cebus apella*, *Pan troglodytes*
```{r ecoconsexcl}
# exclude outliers
data1_PC_excl <- data1_PC %>%
                    filter(!Genus_species %in% c("Cebus_capucinus", "Cebus_apella", "Pan_troglodytes"))

# comparative data for PGLS
comp_data_excl <- comparative.data(phy = Petree, data = data1_PC_excl, names.col = Genus_species, vcv = TRUE, na.omit = FALSE, warn.dropped = TRUE ,vcv.dim=3)

# PGLS analyses
model1 <- pgls(PC1.Ecological.Consequence ~  log(Body.Mass) + log(Brain.Size), data = comp_data_excl, lambda='ML')
kable_pgls(model1)
# model1 <- pgls(PC2.Ecological.Consequence ~  log(Body.Mass) + log(Brain.Size), data = comp_data_excl, lambda='ML')
# kable_pgls(model1)

```


<br><br>



## Relationship between social and ecological consequences
```{r common sample consequences}
# Merge social and ecological PCs to data
data1_soc_eco_cons <- 
  data1 %>% 
    left_join(pca.soc.cons$PC.scores, by = 'Genus_species') %>% 
    left_join(pca.eco.cons$PC.scores, by = 'Genus_species') %>% 
    dplyr::select('Genus_species', 'Body.Mass', 'Brain.Size', dplyr::matches('PC1')) %>% 
    filter(complete.cases(.))

# add residuals for plotting
data1_soc_eco_cons$ResBrainBody <- resid(m1 <- lm(log(Brain.Size) ~ log(Body.Mass), 
                                                 data = data1_soc_eco_cons, 
                                                 na.action = na.exclude)
                                        )
# comparative data
comp_data <- comparative.data(phy = Petree, data = data1_soc_eco_cons, 
                              names.col = Genus_species, vcv = TRUE, 
                              na.omit = FALSE, warn.dropped = TRUE , vcv.dim = 3)


```

```{r}
model1 <- pgls(PC1.Social.Consequence ~  PC1.Ecological.Consequence + log(Body.Mass) + log(Brain.Size), 
               data = comp_data, 
               lambda='ML') 
kable_pgls(model1)


model1 <- pgls(PC1.Ecological.Consequence ~ PC1.Social.Consequence + log(Body.Mass) + log(Brain.Size),
               data = comp_data, 
               lambda='ML') 
kable_pgls(model1)
```

<br>

```{r}

data1_soc_cons <- merge(data1, pca.soc.cons$PC.scores, by="Genus_species", all.x=T) %>% 
  dplyr::select(family, Genus_species, Brain.Size, Body.Mass, PC1.Social.Consequence) %>% 
  filter(complete.cases(.))

# add residuals to data set for plotting
data1_soc_cons$ResBrainBody <- resid(m1<-lm(log(Brain.Size) ~ log(Body.Mass), data = data1_soc_cons, na.action=na.exclude))


plot.soc.cons <- data1_soc_cons %>% 
 ggplot(., aes(x = ResBrainBody, y = PC1.Social.Consequence)) +
    geom_point(aes(color = family, shape = family), size = 2.5) + 
    scale_shape_manual(values=c(15, 16, 17, 18, 11, 13, 8, 10, 25, 10, 12, 7, 4)) +
    scale_color_manual(values = c(brewer.pal(n = 12, name = "Paired"), '#000000')) +
    geom_smooth(method='lm', se = FALSE, color = 'darkgray') + 
    labs(x = 'Residuals brain size', y = 'PC 1 social consequences') +
    theme(panel.border = element_rect(fill = NA, colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          strip.background = element_blank(),
          axis.line = element_line(colour = "grey"),
          legend.key = element_rect(fill = "white")
          ) +
    geom_text(x = -0.81, y = 60, label = 'A')





data1_eco_cons <- merge(data1, pca.eco.cons$PC.scores, by="Genus_species", all.x=T) %>% 
  dplyr::select(family, Genus_species, Brain.Size, Body.Mass, PC1.Ecological.Consequence) %>% 
  filter(complete.cases(.))

# add residuals to data set for plotting
data1_eco_cons$ResBrainBody <- resid(m1<-lm(log(Brain.Size) ~ log(Body.Mass), data = data1_eco_cons, na.action=na.exclude))

plot.eco.cons <- data1_eco_cons %>% 
 ggplot(., aes(x = ResBrainBody, y = PC1.Ecological.Consequence)) +
    geom_point(aes(color = family, shape = family), size = 2.5) + 
    scale_shape_manual(values=c(15, 16, 17, 18, 11, 13, 8, 10, 25, 10, 12, 7, 4)) +
    scale_color_manual(values = c(brewer.pal(n = 12, name = "Paired"), '#000000')) +
    geom_smooth(method='lm', se = FALSE, color = 'darkgray') + 
    labs(x = 'Residuals brain size', y = 'PC1 ecological consequences') +
    theme(panel.border = element_rect(fill = NA, colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          strip.background = element_blank(),
          axis.line = element_line(colour = "grey"),
          legend.key = element_rect(fill = "white")
          ) +
    geom_text(x = -0.75, y = 37, label = 'B') 



plot.soc.eco.cons <- data1_soc_eco_cons %>%
  left_join(data1[,c("family", 'Genus_species')], by = 'Genus_species') %>% 
 ggplot(., aes(x = PC1.Ecological.Consequence, y = PC1.Social.Consequence)) +
    geom_point(aes(color = family, shape = family), size = 2.5) + 
    scale_shape_manual(values=c(15, 16, 17, 18, 11, 13, 8, 10, 25, 10, 12, 7, 4)) +
    scale_color_manual(values = c(brewer.pal(n = 12, name = "Paired"), '#000000')) +
    geom_smooth(method='lm', se = FALSE, color = 'darkgray') + 
    labs(x = 'PC1 ecological consequences', y = 'PC1 social consequences') +
    theme(panel.border = element_rect(fill = NA, colour = "black"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          strip.background = element_blank(),
          axis.line = element_line(colour = "grey"),
          legend.key = element_rect(fill = "white")
          ) +
    geom_text(x = -8, y = 59, label = 'C') 


plot.soc.cons + plot.eco.cons + plot.soc.eco.cons
```


<br><br>


### Excluding outliers - *Cebus capucinus*, *Cebus apella*, *Pan troglodytes*
```{r socecoconsexcl}

# excluding outliers
data1_soc_eco_cons_excl <- data1_soc_eco_cons %>% 
                                filter(!Genus_species %in% c("Cebus_capucinus", "Cebus_apella", "Pan_troglodytes"))


# comparative data
comp_data_excl <- comparative.data(phy = Petree, data = data1_soc_eco_cons_excl, 
                              names.col = Genus_species, vcv = TRUE, 
                              na.omit = FALSE, warn.dropped = TRUE , vcv.dim = 3)

# PGLS regressions
model1 <- pgls(PC1.Social.Consequence ~ PC1.Ecological.Consequence,
               data = comp_data_excl, 
               lambda='ML') 
kable_pgls(model1)

model1 <- pgls(PC1.Social.Consequence ~ PC1.Ecological.Consequence + log(Body.Mass) + log(Brain.Size),
               data = comp_data_excl, 
               lambda='ML') 
kable_pgls(model1)

model1 <- pgls(PC1.Ecological.Consequence ~ PC1.Social.Consequence,
               data = comp_data_excl, 
               lambda='ML') 
kable_pgls(model1)

model1 <- pgls(PC1.Ecological.Consequence ~ PC1.Social.Consequence + log(Body.Mass) + log(Brain.Size),
               data = comp_data_excl, 
               lambda='ML') 
kable_pgls(model1)


```



<br><br>



## Reclassification of opportunities to consequences: fission-fusion and extractive foraging

<br> 

Reclassifiying fission-fusion and extractive foraging as consequence variables made the original results even stronger. 
The factor loadings of pPCA on the *opportunity* variables are equivalent to the original analysis (Tables \@ref(tab:socoppalt), \@ref(tab:ecooppalt)),
and the subsequent PGLS regressions show even stronger evidence for ecological rather than social factors
driving brain size evolution. In fact, whereas the social opportunity PCs show no effect on brain size (PGLS: N = 67, λ = 0.99, β PC1social = 0.005 (p = 0.114); β PC2social = 0.004 (p = 0.157)), both PCs of the ecological domain show significant effects (PGLS: N = 50, λ = 1.00, β PC1ecology = 0.006 (p = 0.012); β PC2ecology = 0.004 (p = 0.022)). These results hold when combining the four PCs into a single regression model (PGLS: N = 43, λ = 1.00, β PC1social = 0.002 (p = 0.655); β PC2social = 0.004 (p = 0.358), β PC1ecology = 0.006 (p = 0.030); β PC2ecology = 0.005 (p = 0.045)).

<br> 

Also in case of the *consequences*, the pPCA as well as the subsequent PGLS regressions result in equivalent patterns as the original analysis. For the ecological and social domain, all variables load highly on the first PC (Tables \@ref(tab:socconsalt), \@ref(tab:ecoconsalt)), and relative brain size shows strong effects on both, the social and ecological consequence PC (socio-cognitive PC1 PGLS: N = 55, λ = 0.00, β Brain = 16.393 (p = 0.007); eco-cognitive PC1 PGLS: N = 53, λ = 0.91, β Brain = 20.033 (p = 0.015); eco-cognitive PC2 PGLS: N = 53, λ = 0.00, β Brain = 17.910 (p < 0.001)). Also the relationsip between the social and ecological consequence PCs is highly significant (PGLS: N = 31, λ = 0.00, β PC1 Ecological Cons. = 0.889 (p < 0.001)), whereas there is no relationship between the opportunity PCs (results not shown).


<br><br> 


### Social opportunities

**Phylogenetic PCA**
```{r, results='hide'}

# choose variables to perform pPCA on --> wihtout fission fusion
variables <- c('Home range overlap', 'Vocal terr. advertisement',
                'Group size', 'Gregariousness', #'Fission-fusion',
                'Body size dimorphism', 'Visual trait dimorphism',
                'Cooperative breeding', 'Dispersal', 'Social system',
                'Mating system')

# Phylogenetic PCA (function in 00_socio_ecology_functions.R)
pca.soc.opp.alt <- phylo_pca(vars = variables, 
                             data = data1, 
                             tree = Petree, 
                             type = 'Social Opportunity')
```

```{r socoppalt}
# output table PCA
kable_phylo_pca_loadings(pca.soc.opp.alt$PC.loadings)
```

<br><br>

**PGLS with PC scores**
```{r}
# add individual PC scores to data set
data1_soc_opp.alt <- merge(data1, pca.soc.opp.alt$PC.scores, by = "Genus_species", all.x = T)
# add residuals to data set for plotting
data1_soc_opp.alt$ResBrainBody <- resid(m1 <- lm(log(Brain.Size) ~ log(Body.Mass), data = data1_soc_opp.alt, na.action = na.exclude))

# comparative data for PGLS
comp_data.alt <- comparative.data(phy = Petree, data = data1_soc_opp.alt, names.col = Genus_species, 
                              vcv = TRUE, na.omit = FALSE, warn.dropped = TRUE ,vcv.dim = 3)

# PGLS analyses
# model1 <- pgls(log(Brain.Size) ~  log(Body.Mass) + PC1.Social.Opportunity, data = comp_data.alt, lambda = 'ML')
# kable_pgls(model1)
# model1 <- pgls(log(Brain.Size) ~  log(Body.Mass) + PC2.Social.Opportunity, data = comp_data.alt, lambda = 'ML')
# kable_pgls(model1)
model1 <- pgls(log(Brain.Size) ~  log(Body.Mass) + PC1.Social.Opportunity + PC2.Social.Opportunity, data = comp_data.alt, lambda = 'ML')
kable_pgls(model1)

```


<br><br>


### Ecological opportunities

**Phylogenetic PCA**
```{r, results='hide'}

# choose variables to perform pPCA on:
variables <- c('Predation risk', 'Mobility D-index', 'Env. seasonality',
               '% insects and meat in diet', '% fruits and seeds in diet', '% leaves in diet', 
               #'Extractive foraging', 
               'Diet quality', 'Substrate', 'Activity', 'Habitat')

# Phylogenetic PCA (function in 00_socio_ecology_functions.R)
pca.eco.opp.alt <- phylo_pca(vars = variables, 
                         data = data1, 
                         tree = Petree, 
                         type = 'Ecological Opportunity',
                         invert.loading = 'PC2')
```

```{r ecooppalt}
# output table PCA
kable_phylo_pca_loadings(pca.eco.opp.alt$PC.loadings)
```

<br><br>

**PGLS with PC scores**
```{r}
# add individual PC scores to data set
data1_eco_opp.alt <- merge(data1, pca.eco.opp.alt$PC.scores, by = "Genus_species", all.x = T)
# add residuals to data set for plotting
data1_eco_opp.alt$ResBrainBody <- resid(m1 <- lm(log(Brain.Size) ~ log(Body.Mass), data = data1_eco_opp.alt, na.action = na.exclude))

# comparative data for PGLS
comp_data.alt <- comparative.data(phy = Petree, data = data1_eco_opp.alt, names.col = Genus_species, vcv = TRUE, na.omit = FALSE, warn.dropped = TRUE ,vcv.dim = 3)

# PGLS analyses
# model1 <- pgls(log(Brain.Size) ~  log(Body.Mass) + PC1.Ecological.Opportunity, data = comp_data.alt, lambda = 'ML')
# kable_pgls(model1)
# model1 <- pgls(log(Brain.Size) ~  log(Body.Mass) + PC2.Ecological.Opportunity, data = comp_data.alt, lambda = 'ML')
# kable_pgls(model1)
model1 <- pgls(log(Brain.Size) ~  log(Body.Mass) + PC1.Ecological.Opportunity + PC2.Ecological.Opportunity, data = comp_data.alt, lambda='ML')
kable_pgls(model1)

```

<br><br>

### Social and ecological opportunities - common sample
```{r}

# Merge social and ecological PCs to data
data1_soc_eco_opp_alt <- 
  data1 %>% 
    left_join(pca.soc.opp.alt$PC.scores, by = 'Genus_species') %>% 
    left_join(pca.eco.opp.alt$PC.scores, by = 'Genus_species') %>% 
    dplyr::select('Genus_species', 'Body.Mass', 'Brain.Size', dplyr::matches('PC1|PC2')) %>% 
    filter(complete.cases(.))

# comparative data
comp_data_alt <- comparative.data(phy = Petree, data = data1_soc_eco_opp_alt, 
                                  names.col = Genus_species, vcv = TRUE, 
                                  na.omit = FALSE, warn.dropped = TRUE ,
                                  vcv.dim = 3)

# PGLS 
model1 <- pgls(log(Brain.Size) ~  log(Body.Mass) + PC1.Ecological.Opportunity + PC2.Ecological.Opportunity +
                 PC1.Social.Opportunity + PC2.Social.Opportunity, data = comp_data_alt, lambda='ML')
kable_pgls(model1)
```


<br><br>


### Social consequences

**Phylogenetic PCA**
```{r, results='hide'}

# choose variables to perform pPCA on:
variables <- c('Fission-fusion', 'Social learning frequency', 'Coalition formation',
               'Social hunting','Food sharing among adults')

# Phylogenetic PCA (function in 00_socio_ecology_functions.R)
pca.soc.cons.alt <- phylo_pca(vars = variables, 
                         data = data1, 
                         tree = Petree, 
                         type = 'Social Consequence',
                         invert.loading <- c('PC1', 'PC2'))
```

```{r socconsalt}
# output table PCA
kable_phylo_pca_loadings(pca.soc.cons.alt$PC.loadings)
```

<br><br>

**PGLS with PC scores**
```{r}
# add individual PC scores to data set
data1_PC_alt <- merge(data1, pca.soc.cons.alt$PC.scores, by="Genus_species", all.x=T)
# add residuals to data set for plotting
data1_PC$ResBrainBody <- resid(m1<-lm(log(Brain.Size) ~ log(Body.Mass), data = data1_PC_alt, na.action=na.exclude))

# comparative data for PGLS
comp_data_alt <- comparative.data(phy = Petree, data = data1_PC_alt, names.col = Genus_species, vcv = TRUE, na.omit = FALSE, warn.dropped = TRUE ,vcv.dim=3)

# PGLS analyses
model1 <- pgls(PC1.Social.Consequence ~  log(Body.Mass) + log(Brain.Size), data = comp_data_alt, lambda='ML')
kable_pgls(model1)
model1 <- pgls(PC2.Social.Consequence ~  log(Body.Mass) + log(Brain.Size), data = comp_data_alt, lambda='ML')
kable_pgls(model1)

```


<br><br>


### Ecological consequences

**Phylogenetic PCA**
```{r, results = 'hide'}

# choose variables to perform pPCA on:
variables <- c('Extractive foraging','Degree of buffering env. seasonality', 
               'Diet breadth', 'Hunting', 'Tool use', 'Innovation frequency')

# Phylogenetic PCA (function in 00_socio_ecology_functions.R)
pca.eco.cons.alt <- phylo_pca(vars = variables, 
                         data = data1, 
                         tree = Petree, 
                         type = 'Ecological Consequence')
```

```{r ecoconsalt}
# output table PCA
kable_phylo_pca_loadings(pca.eco.cons.alt$PC.loadings)
```

<br><br>

**PGLS with PC scores**
```{r}
# add individual PC scores to data set
data1_PC_alt <- merge(data1, pca.eco.cons.alt$PC.scores, by="Genus_species", all.x=T)
# add residuals to data set for plotting
data1_PC$ResBrainBody <- resid(m1<-lm(log(Brain.Size) ~ log(Body.Mass), data = data1_PC_alt, na.action = na.exclude))

# comparative data for PGLS
comp_data_alt <- comparative.data(phy = Petree, data = data1_PC_alt, names.col = Genus_species, vcv = TRUE, na.omit = FALSE, warn.dropped = TRUE ,vcv.dim=3)

# PGLS analyses
model1 <- pgls(PC1.Ecological.Consequence ~  log(Body.Mass) + log(Brain.Size), data = comp_data_alt, lambda='ML')
kable_pgls(model1)
model1 <- pgls(PC2.Ecological.Consequence ~  log(Body.Mass) + log(Brain.Size), data = comp_data_alt, lambda='ML')
kable_pgls(model1)

```




<br><br>




# Supplementary Tables and Figures: Phylogenetic path analyses

<br>

```{r echo=FALSE, out.height = 400, out.width = 400, fig.align = 'center', fig.cap = "Phylogenetic Path Analysis. Candidate models A: Opportunities --> brain size --> consequences."}
knitr::include_graphics(path = 'Plots/Path_models_A.png')
```

<br>

```{r echo=FALSE, out.height = 400, out.width = 400, fig.align = 'center', fig.cap = "Phylogenetic Path Analysis. Candidate models B: Opportunities <-- brain size <-- consequences."}
knitr::include_graphics(path = 'Plots/Path_models_B.png')
```

<br>

```{r echo=FALSE, out.height = 400, out.width = 400, fig.align = 'center', fig.cap = "Phylogenetic Path Analysis. Candidate models C: Opportunities --> brain size <-- consequences."}
knitr::include_graphics(path = 'Plots/Path_models_C.png')
```

<br>

```{r echo=FALSE, out.height = 400, out.width = 400, fig.align = 'center', fig.cap = "Phylogenetic Path Analysis. Candidate models D: Opportunities <-- brain size --> consequences."}
knitr::include_graphics(path = 'Plots/Path_models_D.png')
```

<br><br>

```{r}
# # Merge social and ecological opportunities & consequences PCs to data
data1_soc_eco_opp_cons <-
   data1 %>%
     left_join(pca.soc.opp$PC.scores, by = 'Genus_species') %>% 
     left_join(pca.eco.opp$PC.scores, by = 'Genus_species') %>% 
     left_join(pca.soc.cons$PC.scores, by = 'Genus_species') %>%
     left_join(pca.eco.cons$PC.scores, by = 'Genus_species') %>%
     dplyr::select('Genus_species', 'Body.Mass', 'Brain.Size', dplyr::matches('PC1|PC2')) %>%
     dplyr::select(-PC2.Social.Consequence, -PC2.Ecological.Consequence) %>% 
     filter(complete.cases(.))
 
# add residuals for path analysis
data1_soc_eco_opp_cons$Residuals_brain <- resid(m1<-lm(log(Brain.Size) ~ log(Body.Mass), data = data1_soc_eco_opp_cons, na.action = na.exclude))

# add rownmaes for path analysis
rownames(data1_soc_eco_opp_cons) <- data1_soc_eco_opp_cons$Genus_species

# # comparative data
comp_data <- comparative.data(phy = Petree, data = data1_soc_eco_opp_cons,
                              names.col = Genus_species, vcv = TRUE,
                              na.omit = FALSE, warn.dropped = TRUE , vcv.dim = 3)
```


```{r}

# DAGs: all possible models (function from 00_socio_ecology_functions.R)
models <- phylopath_DAGs()
# plot 
# plot(models$D1)


# tree
matches <- match(Petree$tip.label, data1_soc_eco_opp_cons$Genus_species, nomatch=0)
not <- subset(Petree$tip.label, matches==0)
tree_pruned_pa <- drop.tip(Petree, not)
  
  
# run path analysis (with forcing an order):
# result <- phylo_path(models, data = data1_PC_soc_eco_opp_out_pa, tree = tree_pruned_pa, order=c("PC1.Social.Opportunity","PC2.Social.Opportunity", "PC1.Ecological.Opportunity", "PC2.Ecological.Opportunity", "ResBrainBody_new","PC1.Social.consequences", "PC1.Ecological.consequences"))
  
#run path analysis (without forcing an order):
#result <- phylo_path(models, data = data1_PC_soc_eco_opp_out_pa, tree = tree_pruned_pa)
result <- phylo_path(models, data = data1_soc_eco_opp_cons, tree = tree_pruned_pa)

# nice table
smry.tab <- summary(result)[,-c(3,8,9)]
rownames(smry.tab) <- NULL
smry.tab %>%
  kable_custom(caption = 'Phylogenetic path analysis. N = 29. Given are the number of conditional independencies (= number of d-separation statements) (k), C statistic (C), p-value (p), corrected C statistic information criterion (CICc) and the difference in the CICc (delta CICc) for each of the 28 candidate path models. Models A3 and A3 show the best goodness of fit (delta CICc < 3).') %>% 
  row_spec(1:2, bold = T, color = "black", background = "lightgrey")

# Extract and estimate the best supported model from a phylogenetic path analysis:
# best_model <- best(result)
A3 <- choice(result, 'A3')
#plot(A3)
# A3$coef
# A3$coef - (1.96*A3$se) # lower 95% CI
# A3$coef + (1.96*A3$se) # upper 95% CI

A2 <- choice(result, 'A2')
#plot(A2)
# A2$coef
# A2$coef - (1.96*A2$se) # lower 95% CI
# A2$coef + (1.96*A2$se) # upper 95% CI

# Extract and average the best supported models from a phylogenetic path analysis.
average_model <- average(result, cut_off = 3)
# xtable(average_model$coef)
# xtable(average_model$lower)
# xtable(average_model$upper)
# plot(average_model)
# plot(best_model)

# Plot path coefficients and their confidence intervals or standard errors.
# plot(average_model)
# coef_plot(average_model)

# Plot a directed acyclic graph with path coefficients.
# plot.fitted_DAG()

# Plot several causal hypothesis at once.
# plot_model_set()
```


<br><br>


```{r echo=FALSE, dpi = 50, fig.align = 'center', fig.cap = "Phylogenetic Path Analysis: Best fit models A3 (top) and A2 (bottom). Given are the standardized regression coefficients and the corresponding 95%-confidence intervals (CI). Significant coefficients (0 ∈/ CI) are indicated in bold."}
knitr::include_graphics(path = 'Plots/Path_models_A3_A2.png')
```

<br>

```{r echo=FALSE, dpi = 50, fig.align = 'center', fig.cap = "Phylogenetic Path Analysis. Average model, based on models A3 and A2."}
knitr::include_graphics(path = 'Plots/Average_path_model.png')
```

